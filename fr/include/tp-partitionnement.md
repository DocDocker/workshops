## TP sur le partitionnement

<div class="slide-content">

  * Clés étrangères
  * Fonctions   
    * `pg_partition_root()`
    * `pg_partition_ancestors()`
    * `pg_partition_tree()`
  * _Tablespace_ des tables filles dans l'ordre `CREATE TABLE`
  * Commande `\dP`

</div>  

<div class="notes">

</div>

----

### Clés étrangères dans les tables partitionnées 

<div class="slide-content">

  * Support des clés étrangères
  
</div>


<div class="notes">

Nous allons mettre en place une clé étrangère dans une tables partitionnée. 
La relation sera alors créée dans chacune des partitions de celle-ci.

Reprise de l'exemple du [Workshop v10](https://github.com/dalibo/workshops/blob/master/fr/100-postgresql_10.md) :

```sql
$ CREATE TABLE lieu (id INT PRIMARY KEY, nom TEXT);
$ INSERT INTO lieu VALUES  (1,'Lyon'),(2,'Nantes'),(3,'Paris');
$ CREATE TABLE meteo (                                                            
   t_id INTEGER GENERATED BY DEFAULT AS IDENTITY,                               
   id_lieu INT REFERENCES lieu(id) NOT NULL,                                                          
   heure_mesure timestamp DEFAULT now(),                                        
   temperature real NOT NULL                                                    
 ) PARTITION BY RANGE (id_lieu, heure_mesure);                                     
CREATE TABLE meteo_lyon_201709 PARTITION of meteo FOR VALUES                    
   FROM (1, '2017-09-01 00:00:00') TO (1, '2017-10-01 00:00:00');         
CREATE TABLE meteo_lyon_201710 PARTITION of meteo FOR VALUES                    
   FROM (1, '2017-10-01 00:00:00') TO (1, '2017-11-01 00:00:00');         
CREATE TABLE meteo_nantes_201709 PARTITION of meteo FOR VALUES                  
   FROM (2, '2017-09-01 00:00:00') TO (2, '2017-10-01 00:00:00'); 
CREATE TABLE meteo_nantes_201710 PARTITION of meteo FOR VALUES                  
   FROM (2, '2017-10-01 00:00:00') TO (2, '2017-11-01 00:00:00'); 
CREATE TABLE meteo_paris_201709 PARTITION of meteo FOR VALUES                   
   FROM (3, '2017-09-01 00:00:00') TO (3, '2017-10-01 00:00:00');   
CREATE TABLE meteo_paris_201710 PARTITION of meteo FOR VALUES                   
   FROM (3, '2017-10-01 00:00:00') TO (3, '2017-11-01 00:00:00');   
```

Nous utilisons une fonction pour peupler cette table :

```sql
$ CREATE OR REPLACE FUNCTION public.peuple_meteo()
 RETURNS text
 LANGUAGE plpgsql
AS $function$    
DECLARE    
   lieux integer[] := '{}';    
   v_lieu integer;    
   v_heure timestamp;    
   v_temperature real;    
   v_nb_insertions integer := 500000;    
   v_insertion integer;    
BEGIN    
   lieux[0]=1;    
   lieux[1]=2;    
   lieux[2]=3;    
   FOR v_insertion IN 1 .. v_nb_insertions LOOP    
      v_lieu=lieux[floor((random()*3))::int];    
      v_heure='2017-09-01'::timestamp    
                   + make_interval(days => floor((random()*60))::int,    
                              secs => floor((random()*86400))::int);    
      v_temperature:=round(((random()*14))::numeric+10,2);    
      IF EXTRACT(MONTH FROM v_heure) = 10 THEN    
          v_temperature:=v_temperature-4;    
      END IF;    
      IF EXTRACT(HOUR FROM v_heure) <= 9    
         OR EXTRACT(HOUR FROM v_heure) >= 20 THEN    
          v_temperature:=v_temperature-5;    
      ELSEIF EXTRACT(HOUR FROM v_heure) >= 12    
         AND EXTRACT(HOUR FROM v_heure) <= 17 THEN    
          v_temperature:=v_temperature+5;    
      END IF;    
      INSERT INTO meteo (id_lieu,heure_mesure,temperature)    
        VALUES (v_lieu,v_heure,v_temperature);    
   END LOOP;    
   RETURN v_nb_insertions||' mesures de température insérées';    
END;    
$function$;
CREATE FUNCTION

$ SELECT peuple_meteo();
              peuple_meteo              
----------------------------------------
 500000 mesures de température insérées
(1 row)
```
</div>

----

### Fonctions d'information sur le partitionnement

<div class="slide-content">

  * `pg_partition_root(regclass)` 
  * `pg_partition_ancestors(regclass)`
  * `pg_partition_tree(regclass)`
  
</div>

<div class="notes">


```sql
-- table mère d'une partition
$ SELECT pg_partition_root('meteo_nantes_201710');
 pg_partition_root 
-------------------
 meteo
(1 row)

-- ancêtres d'une partition (incluant la partition elle-même)
$ select pg_partition_ancestors('meteo_lyon_201709');
 pg_partition_ancestors 
------------------------
 meteo_lyon_201709
 meteo
(2 rows)

-- Arbre complet d'une table partitionnée
$ select * from pg_partition_tree('meteo');
        relid        | parentrelid | isleaf | level 
---------------------+-------------+--------+-------
 meteo               |             | f      |     0
 meteo_lyon_201709   | meteo       | t      |     1
 meteo_lyon_201710   | meteo       | t      |     1
 meteo_nantes_201709 | meteo       | t      |     1
 meteo_nantes_201710 | meteo       | t      |     1
 meteo_paris_201709  | meteo       | t      |     1
 meteo_paris_201710  | meteo       | t      |     1
(7 rows)
```

</div>

----

### Tablespace des partitions dans l'ordre CREATE TABLE


<div class="slide-content">

  * Préciser le tablespace des tables filles dans l'ordre `CREATE TABLE`
  
</div>


<div class="notes">

Il est maintenant possible de choisir le tablespace d'une partition lors de sa création :

```sql
$ CREATE TABLESPACE tb1 LOCATION '/home/frbn/.pgenv/pgsql/tb1/';
$ CREATE TABLESPACE tb2 LOCATION '/home/frbn/.pgenv/pgsql/tb2/';
$ CREATE TABLE mere (i INT) PARTITION BY RANGE (i);
$ CREATE TABLE fille_1_10 PARTITION OF mere FOR VALUES FROM  (1) TO (5) TABLESPACE tb1;
$ CREATE TABLE fille_6_10 PARTITION OF mere FOR VALUES FROM  (6) TO (10) TABLESPACE tb2;
```
</div>

----

###  \\dP : Affichage des tables partitionnées seules

<div class="slide-content">

</div>

<div class="notes">

```SQL
$ \d
                   Liste des relations
 Schéma |    Nom     |        Type        | Propriétaire 
--------+------------+--------------------+--------------
 public | a_table    | table              | postgres
 public | fille_1_10 | table              | postgres
 public | fille_6_10 | table              | postgres
 public | mere       | table partitionnée | postgres
(4 lignes)

$ \dP
             Liste des relations partitionnées
 Schéma | Nom  | Propriétaire |        Type        | Table 
--------+------+--------------+--------------------+-------
 public | mere | postgres     | table partitionnée | 
(1 ligne)

```

</div>

----
